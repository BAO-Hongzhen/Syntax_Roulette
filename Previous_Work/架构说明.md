# 📐 项目架构说明

## 🎯 架构设计理念

本项目采用**模块化**、**分层**的架构设计，将功能清晰地分离到不同的模块中，便于维护和扩展。

---

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────┐
│           用户界面层 (UI Layer)              │
│         gradio_ui.py - Web界面              │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────┴───────────────────────────┐
│          应用逻辑层 (Logic Layer)            │
│  ┌──────────────┐      ┌─────────────────┐ │
│  │ word_bank.py │      │ comfyui_api.py  │ │
│  │  词库管理     │      │  API调用模块     │ │
│  └──────────────┘      └─────────────────┘ │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────┴───────────────────────────┐
│          数据存储层 (Data Layer)             │
│   data/         output/                     │
│  词库JSON       生成的GIF                    │
└─────────────────────────────────────────────┘
```

---

## 📦 模块详解

### 1. main.py - 主程序入口

**职责**:
- 应用启动入口
- 依赖检查
- 模块初始化
- 协调各模块

**关键函数**:
```python
def check_dependencies()      # 检查依赖
def initialize_components()   # 初始化组件
def main()                    # 主函数
```

**设计原则**:
- 单一职责: 仅负责启动和协调
- 最小依赖: 不包含业务逻辑
- 错误处理: 完善的异常捕获

---

### 2. word_bank.py - 词库管理模块

**职责**:
- 词库存储和管理
- 随机词语抽取
- 句子生成逻辑
- 词库持久化

**核心类**:
```python
class WordBank:
    def __init__()                      # 初始化词库
    def load_default_words()            # 加载默认词
    def load_from_file()                # 从文件加载
    def save_to_file()                  # 保存到文件
    def add_word()                      # 添加单词
    def get_random_word()               # 随机获取
    def generate_simple_sentence()      # 生成简单句
    def generate_detailed_sentence()    # 生成详细句
    def generate_custom_sentence()      # 自定义模式
```

**数据结构**:
```python
self.word_banks = {
    "subjects": [],      # 主语列表
    "verbs": [],         # 动词列表
    "objects": [],       # 宾语列表
    # ... 其他类别
}
```

**句式生成算法**:

1. **简单句式**:
   ```
   主语 + 动词 + 宾语
   = random(subjects) + random(verbs) + random(objects)
   ```

2. **详细句式**:
   ```
   形容词 + 主语 + 副词 + 动词 + 形容词 + 宾语 + 地点 + 时间
   = random(adj) + random(subj) + ... + random(time)
   ```

3. **自定义模式**:
   ```
   根据传入的类别列表动态组合
   ```

**扩展点**:
- 可添加新的词性类别
- 可创建新的句式模板
- 支持多语言词库

---

### 3. comfyui_api.py - ComfyUI API调用模块

**职责**:
- 封装ComfyUI REST API
- 管理工作流提交
- 跟踪生成进度
- 处理结果获取

**核心类**:
```python
class ComfyUIClient:
    def __init__()                     # 初始化客户端
    def test_connection()              # 测试连接
    def queue_prompt()                 # 提交工作流
    def get_history()                  # 获取历史
    def track_progress()               # 跟踪进度
    def create_text2gif_workflow()     # 创建工作流
    def generate_gif()                 # 生成GIF
    def get_image()                    # 获取图像
```

**API交互流程**:
```
1. 创建工作流 (create_text2gif_workflow)
   ↓
2. 提交到队列 (queue_prompt)
   ↓
3. 获取提示词ID
   ↓
4. 轮询检查状态 (track_progress)
   ↓
5. 获取生成结果 (get_image)
   ↓
6. 合成GIF动图
```

**工作流结构**:
```python
workflow = {
    "3": {"class_type": "KSampler", ...},      # 采样器
    "4": {"class_type": "CheckpointLoader"},   # 模型加载
    "5": {"class_type": "EmptyLatentImage"},   # 潜空间
    "6": {"class_type": "CLIPTextEncode"},     # 提示词编码
    "7": {"class_type": "CLIPTextEncode"},     # 负面提示词
    "8": {"class_type": "VAEDecode"},          # VAE解码
    "9": {"class_type": "SaveImage"}           # 保存图像
}
```

**容错机制**:
- 连接失败重试
- 超时处理
- 降级到演示模式

---

### 4. gradio_ui.py - Gradio网页界面模块

**职责**:
- 构建Web用户界面
- 处理用户交互事件
- 展示生成结果
- 管理历史记录

**核心类**:
```python
class GradioInterface:
    def __init__()                       # 初始化界面
    def generate_sentence_handler()      # 句子生成处理
    def generate_gif_handler()           # GIF生成处理
    def create_demo_gif()                # 创建演示GIF
    def get_history_gallery()            # 获取历史
    def create_interface()               # 创建界面
```

**界面布局**:
```
┌──────────────────────────────────────────┐
│              标题和说明                   │
├──────────────┬───────────────────────────┤
│  左侧面板     │     右侧面板              │
│  句子生成     │     GIF生成               │
│  - 句式选择  │     - 参数设置            │
│  - 生成按钮  │     - 生成按钮            │
│  - 句子显示  │     - GIF显示             │
│  - 词库管理  │     - 状态信息            │
├──────────────┴───────────────────────────┤
│              历史记录                     │
│              使用说明                     │
└──────────────────────────────────────────┘
```

**事件流**:
```
用户点击 → 触发处理函数 → 调用业务逻辑 → 更新界面
   ↓            ↓              ↓            ↓
 Button      Handler      WordBank/API   Textbox/Image
```

---

## 🔄 数据流

### 完整数据流图

```
用户输入
   ↓
选择句式 → WordBank.generate_*()
   ↓
随机抽词 → 组合成句子
   ↓
显示句子 ← gradio_ui.generate_sentence_handler()
   ↓
用户确认/调整参数
   ↓
点击生成GIF
   ↓
gradio_ui.generate_gif_handler()
   ↓
   ├─→ [演示模式] → create_demo_gif() → 返回GIF
   │
   └─→ [ComfyUI模式] → comfyui_api.generate_gif()
                          ↓
                    创建工作流
                          ↓
                    提交到ComfyUI
                          ↓
                    跟踪进度
                          ↓
                    获取结果 → 返回GIF
   ↓
显示GIF + 添加到历史
```

---

## 🎨 设计模式

### 1. 分层架构 (Layered Architecture)

```
Presentation Layer (gradio_ui.py)
        ↓
Business Logic Layer (word_bank.py, comfyui_api.py)
        ↓
Data Layer (JSON files, output files)
```

**优点**:
- 职责清晰
- 易于测试
- 可独立开发

### 2. 模块化设计

每个模块都是独立的Python文件，可以单独运行和测试。

**优点**:
- 低耦合
- 高内聚
- 易于维护

### 3. 工厂模式 (句子生成)

`WordBank` 类根据不同的模式生成不同的句子结构。

```python
if pattern_type == "简单句式":
    return generate_simple_sentence()
elif pattern_type == "详细句式":
    return generate_detailed_sentence()
```

### 4. 适配器模式 (ComfyUI集成)

`ComfyUIClient` 封装了ComfyUI的API，提供统一接口。

---

## 🔌 接口设计

### WordBank 接口

```python
# 输入: 无
# 输出: 句子字典
generate_simple_sentence() -> Dict[str, str]

# 输入: 类别名, 单词
# 输出: 无
add_word(category: str, word: str) -> None

# 输入: 文件路径
# 输出: 无
save_to_file(filepath: str) -> None
```

### ComfyUIClient 接口

```python
# 输入: 提示词, 参数
# 输出: GIF路径
generate_gif(prompt: str, ...) -> Optional[str]

# 输入: 无
# 输出: 连接状态
test_connection() -> bool
```

### GradioInterface 接口

```python
# 输入: 句式类型
# 输出: (句子, 详情)
generate_sentence_handler(pattern: str) -> Tuple[str, str]

# 输入: 句子, 参数
# 输出: (GIF路径, 状态)
generate_gif_handler(sentence: str, ...) -> Tuple[str, str]
```

---

## 📁 文件组织

```
syntax_gif_generator/
│
├── main.py                    # 主入口 - 协调者
│
├── modules/                   # 业务逻辑层
│   ├── __init__.py           # 模块初始化
│   ├── word_bank.py          # 词库模块 - 独立可测
│   ├── comfyui_api.py        # API模块 - 独立可测
│   └── gradio_ui.py          # UI模块 - 依赖上面两个
│
├── data/                      # 数据层
│   └── default_words.json    # 默认词库
│
├── output/                    # 输出层
│   └── (生成的GIF文件)
│
├── requirements.txt           # 依赖声明
├── README.md                  # 项目文档
├── 快速开始.md                # 使用指南
└── 启动应用.bat               # 启动脚本
```

**组织原则**:
- 按功能分模块
- 数据与代码分离
- 配置与代码分离
- 文档完善

---

## 🔧 扩展点

### 1. 添加新词性类别

在 `word_bank.py` 的 `word_banks` 字典中添加:

```python
self.word_banks["new_category"] = []
```

### 2. 添加新句式模板

在 `word_bank.py` 中添加新方法:

```python
def generate_new_pattern(self):
    # 自定义逻辑
    return {"sentence": "...", ...}
```

### 3. 更换AI生成服务

修改或扩展 `comfyui_api.py`:

```python
class StableDiffusionClient:
    def generate_gif(self, prompt):
        # 调用其他API
        pass
```

### 4. 自定义界面主题

在 `gradio_ui.py` 中:

```python
gr.Blocks(theme=gr.themes.Custom(...))
```

---

## ✅ 架构优势

### 1. 可维护性
- 模块独立，修改影响小
- 代码清晰，易于理解
- 文档完善，便于接手

### 2. 可测试性
- 每个模块可单独测试
- 接口明确，易于mock
- 业务逻辑与UI分离

### 3. 可扩展性
- 易于添加新功能
- 支持多种句式
- 可接入不同AI服务

### 4. 可复用性
- 模块可独立使用
- 词库系统可复用
- API客户端可复用

---

## 🎯 设计原则遵循

1. **SOLID原则**
   - S: 单一职责 ✅
   - O: 开闭原则 ✅
   - L: 里氏替换 ✅
   - I: 接口隔离 ✅
   - D: 依赖倒置 ✅

2. **DRY原则** (Don't Repeat Yourself)
   - 共同逻辑抽取到函数
   - 避免代码重复

3. **KISS原则** (Keep It Simple, Stupid)
   - 代码简洁明了
   - 避免过度设计

---

## 📊 性能考虑

1. **词库加载**: 启动时一次性加载，避免重复IO
2. **GIF生成**: 异步处理，不阻塞界面
3. **历史记录**: 限制数量，避免内存溢出
4. **API调用**: 超时控制，避免长时间等待

---

## 🔒 错误处理

1. **依赖检查**: 启动前检查，提供明确提示
2. **API调用**: try-except包裹，降级处理
3. **文件操作**: 异常捕获，用户友好提示
4. **用户输入**: 验证和清理

---

<div align="center">

**这个架构设计是否合理？完全合理！** ✅

模块化、分层、易扩展、易维护

[返回README](README.md)

</div>
